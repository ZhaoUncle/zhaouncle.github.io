<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>【k8s】部署 jenkins 并部署 tomcat 服务示例 - 易波叶平</title><meta name="Description" content="【k8s】部署 jenkins 并部署 tomcat 服务示例"><meta property="og:title" content="【k8s】部署 jenkins 并部署 tomcat 服务示例" />
<meta property="og:description" content="【k8s】部署 jenkins 并部署 tomcat 服务示例" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zhaouncle.com/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2/" />
<meta property="og:image" content="https://www.zhaouncle.com/logo.png"/>
<meta property="article:published_time" content="2021-04-12T22:22:02+08:00" />
<meta property="article:modified_time" content="2021-04-12T22:22:02+08:00" />
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://www.zhaouncle.com/logo.png"/>

<meta name="twitter:title" content="【k8s】部署 jenkins 并部署 tomcat 服务示例"/>
<meta name="twitter:description" content="【k8s】部署 jenkins 并部署 tomcat 服务示例"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://www.zhaouncle.com/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2/" /><link rel="prev" href="https://www.zhaouncle.com/%E4%BA%91cdn%E6%B1%87%E6%80%BB%E4%BB%8B%E7%BB%8D/" /><link rel="next" href="https://www.zhaouncle.com/dns%E5%88%B7%E6%96%B0%E5%8A%9E%E6%B3%95/" /><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css"><meta name="google-site-verification" content="L0x8CmbrOx9V21ZwTit7tRmDxdYk3kxALRLqR8GSFg0" /><meta name="msvalidate.01" content="C7D99901D0D018E2FA741CC205405B28" /><meta name="baidu-site-verification" content="Dnx20VKWrw" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "【k8s】部署 jenkins 并部署 tomcat 服务示例",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/www.zhaouncle.com\/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2\/"
        },"image": ["https:\/\/www.zhaouncle.com\/images\/Apple-Devices-Preview.png"],"genre": "posts","keywords": "k8s","wordcount":  6596 ,
        "url": "https:\/\/www.zhaouncle.com\/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2\/","datePublished": "2021-04-12T22:22:02+08:00","dateModified": "2021-04-12T22:22:02+08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
            "@type": "Organization",
            "name": "目瞪狗呆","logo": "https:\/\/cdn.jsdelivr.net\/gh\/ZhaoUncle\/image@main\/blog\/avatar.png"},"author": {
                "@type": "Person",
                "name": "赵叔"
            },"description": "【k8s】部署 jenkins 并部署 tomcat 服务示例"
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="易波叶平"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>易波叶平</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 所有文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about"> 关于 </a><a class="menu-item" href="/categories/thoughts/" title="杂谈"> 杂谈 </a><a class="menu-item" href="/link" title="友链"> 友链 </a><a class="menu-item" href="https://link.zhaouncle.com" rel="noopener noreffer" target="_blank"><i class='fas fa-link fa-fw'></i>  </a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i>  </a><a class="menu-item" href="https://zhaouncle.com/uptime-status/" title="UpStatus" rel="noopener noreffer" target="_blank"><i class='fas fa-heart fa-fw'></i>  </a><a class="menu-item" href="https://k8syaml.com/" title="k8syaml" rel="noopener noreffer" target="_blank"><i class='fab fa-docker'></i>  </a><a class="menu-item" href="https://www.cnblogs.com/UncleZhao/" title="博客园" rel="noopener noreffer" target="_blank"><i class='fas fa-blog'></i>  </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item language" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                        <select class="language-select" id="language-select-desktop" onchange="location = this.value;"><option value="/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2/" selected>简体中文</option></select>
                    </a><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索" id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="易波叶平"><span class="header-title-pre"><i class='far fa-kiss-wink-heart fa-fw'></i></span>易波叶平</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索" id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">所有文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about" title="">关于</a><a class="menu-item" href="/categories/thoughts/" title="杂谈">杂谈</a><a class="menu-item" href="/link" title="友链">友链</a><a class="menu-item" href="https://link.zhaouncle.com" title="" rel="noopener noreffer" target="_blank"><i class='fas fa-link fa-fw'></i></a><a class="menu-item" href="https://github.com/dillonzq/LoveIt" title="GitHub" rel="noopener noreffer" target="_blank"><i class='fab fa-github fa-fw'></i></a><a class="menu-item" href="https://zhaouncle.com/uptime-status/" title="UpStatus" rel="noopener noreffer" target="_blank"><i class='fas fa-heart fa-fw'></i></a><a class="menu-item" href="https://k8syaml.com/" title="k8syaml" rel="noopener noreffer" target="_blank"><i class='fab fa-docker'></i></a><a class="menu-item" href="https://www.cnblogs.com/UncleZhao/" title="博客园" rel="noopener noreffer" target="_blank"><i class='fas fa-blog'></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a><a href="javascript:void(0);" class="menu-item" title="选择语言">简体中文<i class="fas fa-chevron-right fa-fw"></i>
                    <select class="language-select" onchange="location = this.value;"><option value="/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2/" selected>简体中文</option></select>
                </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content always-active" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">【k8s】部署 jenkins 并部署 tomcat 服务示例</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="http://zhaouncle.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>赵叔</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/k8s/"><i class="far fa-folder fa-fw"></i>k8s</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-04-12">2021-04-12</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6596 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 14 分钟&nbsp;<span id="/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2/" class="leancloud_visitors" data-flag-title="【k8s】部署 jenkins 并部署 tomcat 服务示例">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-环境">1. 环境</a></li>
    <li><a href="#2-发布流程">2. 发布流程</a></li>
    <li><a href="#3-harbor-部署">3. harbor 部署</a></li>
    <li><a href="#4-gitlab-部署">4. gitlab 部署</a></li>
    <li><a href="#5-nfs-server-部署">5. nfs server 部署</a></li>
    <li><a href="#6-在-kubernetes-中部署-jenkins">6. 在 Kubernetes 中部署 jenkins</a>
      <ul>
        <li><a href="#61-创建-jenkins-动态-pvc">6.1 创建 jenkins 动态 pvc</a></li>
        <li><a href="#62-yaml-部署-jenkins">6.2 yaml 部署 jenkins</a></li>
        <li><a href="#63-控制台访问">6.3 控制台访问</a></li>
        <li><a href="#64-jenkins-安装插件">6.4 jenkins 安装插件</a></li>
        <li><a href="#65-删除-pod-重建">6.5 删除 pod 重建</a></li>
        <li><a href="#66-jenkins-在-k8s-中动态创建代理">6.6 jenkins 在 k8s 中动态创建代理</a>
          <ul>
            <li><a href="#661-在-jenkins-中添加-kubernetes-">6.6.1 在 jenkins 中添加 kubernetes ☁️</a></li>
            <li><a href="#662-构建-jenkins-slave-镜像">6.6.2 构建 jenkins-slave 镜像</a></li>
            <li><a href="#663-给-jenkins-slave-pod-添加存储卷以及挂载docker-命令到pod-中">6.6.3 给 Jenkins-Slave pod 添加存储卷，以及挂载docker 命令到Pod 中</a></li>
            <li><a href="#创建-jenkins-job">创建 jenkins job</a></li>
            <li><a href="#测试案例-tomcat-java-demo-gitlim-的-dockerfile">测试案例 tomcat-java-demo gitlim 的 Dockerfile</a></li>
            <li><a href="#授权创建-kubeconfig-文件并保存在-jenkins-中">授权创建 kubeconfig 文件，并保存在 jenkins 中</a></li>
            <li><a href="#把生成的kubeconfig配置文件存放在jenkins-中">把生成的kubeconfig配置文件存放在jenkins 中</a></li>
            <li><a href="#把managed-files-中的配置文件-转换成pipeline-语法">把Managed files 中的配置文件 转换成pipeline 语法</a></li>
            <li><a href="#编写标准的deployyaml-模板">编写标准的deploy.yaml 模板</a></li>
            <li><a href="#在k8s-集群中创建sercret-用于连接harbor仓库用于k8s创建pod时-拉取镜像">在K8S 集群中创建sercret 用于连接Harbor仓库（用于K8S创建POD时 拉取镜像）</a></li>
            <li><a href="#定义环境变量使用参数化构建修改deployyaml文件">定义环境变量，使用参数化构建，修改deploy.yaml文件</a></li>
            <li><a href="#heading"></a></li>
          </ul>
        </li>
        <li><a href="#完整的pipeline-流水线-脚本">完整的pipeline 流水线 脚本</a></li>
      </ul>
    </li>
    <li><a href="#参考">参考</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="1-环境">1. 环境</h1>
<ul>
<li>k8s 集群：v1.20.4 版本</li>
</ul>
<table>
<thead>
<tr>
<th>k8s-master1</th>
<th>192.168.110.235</th>
</tr>
</thead>
<tbody>
<tr>
<td>k8s-node1</td>
<td>192.168.110.236</td>
</tr>
<tr>
<td>k8s-node2</td>
<td>192.168.110.237</td>
</tr>
<tr>
<td>gitlab</td>
<td>192.168.110.238</td>
</tr>
<tr>
<td>nfs，harbor</td>
<td>192.168.110.239</td>
</tr>
</tbody>
</table>
<h1 id="2-发布流程">2. 发布流程</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412222813.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412222813.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412222813.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412222813.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412222813.png"
        title="img" /></p>
<p>流程：</p>
<ul>
<li>拉取代码 git checkout</li>
<li>编译代码 mvn clean</li>
<li>打包镜像 并上传镜像仓库</li>
<li>使用yaml 模板文件部署用镜像仓库中的镜像，kubectl 命令部署pod</li>
<li>开发测试</li>
</ul>
<h1 id="3-harbor-部署">3. harbor 部署</h1>
<p>参考：<a href="https://zhaouncle.com/k8s%E7%8E%AF%E5%A2%83-harbor%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener noreffer">Harbor安装</a></p>
<h1 id="4-gitlab-部署">4. gitlab 部署</h1>
<p>参考：<a href="https://zhaouncle.com/k8s%E7%8E%AF%E5%A2%83-gitlab%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener noreffer">Gitlab安装</a></p>
<h1 id="5-nfs-server-部署">5. nfs server 部署</h1>
<p>参考：<a href="https://zhaouncle.com/k8s%E7%8E%AF%E5%A2%83-nfs%E5%8A%A8%E6%80%81%E5%AD%98%E5%82%A8%E5%8D%B7%E9%83%A8%E7%BD%B2/" target="_blank" rel="noopener noreffer">K8s环境 nfs 动态存储卷部署</a></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#在原有的 nfs server 上面添加 jenkins 的 nfs
mkdir -p /data/nfs/jenkins
echo &#34;/data/nfs/jenkins *(rw,sync,no_root_squash,no_subtree_check)&#34; &gt;&gt; /etc/exports
systemctl restart nfs &amp;&amp; systemctl restart rpcbind
</code></pre></td></tr></table>
</div>
</div><h1 id="6-在-kubernetes-中部署-jenkins">6. 在 Kubernetes 中部署 jenkins</h1>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412223131.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412223131.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412223131.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412223131.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412223131.png"
        title="img" /></p>
<h2 id="61-创建-jenkins-动态-pvc">6.1 创建 jenkins 动态 pvc</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl create namespace nfs

helm repo add helm-stable https://charts.helm.sh/stable        
helm repo update

cat &gt;  jenkins-client-nfs.yaml &lt;&lt; EOF
# NFS 设置
nfs:
  server: 192.168.110.239
  path: /data/nfs/jenkins
storageClass:
  # 此配置用于绑定 PVC 和 PV
  name: jenkins-nfs-client
  
  # 资源回收策略
#主要用于绑定的PVC删除后，资源释放后如何处理该PVC在存储设备上写入的数据。
#Retain：保留，删除PVC后，PV保留数据；
#Recycle：回收空间，删除PVC后，简单的清除文件；（NFS和HostPath存储支持）
#Delete：删除，删除PVC后，与PV相连接的后端存储会删除数据；（AWS EBS、Azure Disk、Cinder volumes、GCE PD支持）
  reclaimPolicy: Delete
# 使用镜像
image:
  repository: kubesphere/nfs-client-provisioner
# 副本数量
replicaCount: 1
EOF

#helm 部署 nfs-client-provisioner
helm install jenkins-nfs-storage -n nfs --values jenkins-client-nfs.yaml helm-stable/nfs-client-provisioner
</code></pre></td></tr></table>
</div>
</div><p>###查看运行状态：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 helm]# kubectl get pod,sc -n nfs|grep jenkins
pod/jenkins-nfs-storage-nfs-client-provisioner-6d8974459b-wwh88   1/1     Running   0          50s
storageclass.storage.k8s.io/jenkins-nfs-client    cluster.local/jenkins-nfs-storage-nfs-client-provisioner   Delete          Immediate           true                   50s
</code></pre></td></tr></table>
</div>
</div><h2 id="62-yaml-部署-jenkins">6.2 yaml 部署 jenkins</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">mkdir /data/yml/jenkins -p
cd /data/yml/jenkins
kubectl create namespace ops

cat &gt; jenkins.yml &lt;&lt; EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jenkins
  namespace: ops
  labels:
    name: jenkins
spec:
  replicas: 1
  selector:
    matchLabels:
      name: jenkins 
  template:
    metadata:
      name: jenkins
      labels:
        name: jenkins
    spec:
      serviceAccountName: jenkins
      containers:
        - name: jenkins
          image: jenkins/jenkins
          ports:
            - containerPort: 8080
            - containerPort: 50000
          resources:
            limits:
              cpu: 2
              memory: 4Gi
            requests:
              cpu: 1
              memory: 1Gi
          env:
            - name: LIMITS_MEMORY
              valueFrom:
                resourceFieldRef:
                  resource: limits.memory
                  divisor: 1Mi
            - name: JAVA_OPTS
              value: -Xmx\$(LIMITS_MEMORY)m -XshowSettings:vm -Dhudson.slaves.NodeProvisioner.initialDelay=0 -Dhudson.slaves.NodeProvisioner.MARGIN=50 -Dhudson.slaves.NodeProvisioner.MARGIN0=0.85
          volumeMounts:
            - name: jenkins-home
              mountPath: /var/jenkins_home
      securityContext:
        fsGroup: 1000
      volumes:
      - name: jenkins-home
        persistentVolumeClaim:
          claimName: jenkins
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: jenkins
  namespace: ops
spec:
  storageClassName: &#34;jenkins-nfs-client&#34;
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 10Gi
---
apiVersion: v1
kind: Service
metadata:
  name: jenkins
  namespace: ops
spec:
  selector:
    name: jenkins
  type: NodePort
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
      nodePort: 30008
    - name: agent
      port: 50000
      protocol: TCP
---
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins
  namespace: ops

---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: jenkins
  namespace: ops
rules:
- apiGroups: [&#34;&#34;]
  resources: [&#34;pods&#34;,&#34;events&#34;]
  verbs: [&#34;create&#34;,&#34;delete&#34;,&#34;get&#34;,&#34;list&#34;,&#34;patch&#34;,&#34;update&#34;,&#34;watch&#34;]
- apiGroups: [&#34;&#34;]
  resources: [&#34;pods/exec&#34;]
  verbs: [&#34;create&#34;,&#34;delete&#34;,&#34;get&#34;,&#34;list&#34;,&#34;patch&#34;,&#34;update&#34;,&#34;watch&#34;]
- apiGroups: [&#34;&#34;]
  resources: [&#34;pods/log&#34;]
  verbs: [&#34;get&#34;,&#34;list&#34;,&#34;watch&#34;]
- apiGroups: [&#34;&#34;]
  resources: [&#34;secrets&#34;,&#34;events&#34;]
  verbs: [&#34;get&#34;]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: jenkins
  namespace: ops
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: jenkins
subjects:
- kind: ServiceAccount
  name: jenkins
EOF


kubectl apply -f jenkins.yml

</code></pre></td></tr></table>
</div>
</div><p>###查看安装结果</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 ~]# kubectl get pod,pvc,svc -n ops -o wide
NAME                          READY   STATUS    RESTARTS   AGE   IP             NODE        NOMINATED NODE   READINESS GATES
pod/jenkins-f656474b8-bjv5s   1/1     Running   0          20s   10.244.36.92   k8s-node1   &lt;none&gt;           &lt;none&gt;

NAME                            STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS         AGE   VOLUMEMODE
persistentvolumeclaim/jenkins   Bound    pvc-037d24b4-16cf-4900-ac06-76699dbc7c24   10Gi       RWX            jenkins-nfs-client   20s   Filesystem

NAME              TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)                        AGE   SELECTOR
service/jenkins   NodePort   10.0.0.229   &lt;none&gt;        80:30008/TCP,50000:30619/TCP   20s   name=jenkins
</code></pre></td></tr></table>
</div>
</div><h2 id="63-控制台访问">6.3 控制台访问</h2>
<p>访问方式：k8s master/node ip+ NodePort</p>
<p>访问地址：192.168.110.235:30008</p>
<p>查看密码：<code>kubectl logs -n ops jenkins-f656474b8-bjv5s |grep -A 3 password</code></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231058.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231058.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231058.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231058.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231058.png"
        title="img" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231105.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231105.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231105.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231105.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231105.png"
        title="img" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231123.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231123.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231123.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231123.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231123.png"
        title="img" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231130.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231130.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231130.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231130.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412231130.png"
        title="img" /></p>
<h2 id="64-jenkins-安装插件">6.4 jenkins 安装插件</h2>
<p>默认从国外网络下载插件，会比较慢，建议修改成国内源：</p>
<p>只需要到nfs上，修改PVC挂载的内容即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cd /data/nfs/jenkins/ops-jenkins-pvc-037d24b4-16cf-4900-ac06-76699dbc7c24/updates
cp default.json default.json-bak

#修改插件的下载地址为国内的地址
sed -i &#39;s/https:\/\/updates.jenkins.io\/download/https:\/\/mirrors.tuna.tsinghua.edu.cn\/jenkins/g&#39; default.json

#修改jenkins启动时检测的URL网址，改为国内baidu的地址
sed -i &#39;s/http:\/\/www.google.com/https:\/\/www.baidu.com/g&#39; default.json

</code></pre></td></tr></table>
</div>
</div><h2 id="65-删除-pod-重建">6.5 删除 pod 重建</h2>
<p><code>kubectl delete pod -n ops jenkins-f656474b8-bjv5s</code></p>
<p>修改完后，jenkins 会重建，打开浏览器访问: <a href="http://nodeport:30008/" target="_blank" rel="noopener noreffer">http://NodeIP:30008</a></p>
<p>输入账户密码从新登陆 jenkins 控制台</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412232609.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412232609.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412232609.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412232609.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412232609.png"
        title="img" /></p>
<p>依次点击 管理Jenkins（Manage Jenkins）-&gt;系统配置(System Configuration)&ndash;&gt;管理插件(Manage Pluglns)&ndash;&gt;</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233341.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233341.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233341.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233341.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233341.png"
        title="image-20210412233341764" /></p>
<p>分别搜索 Git/Git Parameter/Pipeline/kubernetes/Config File Provider，选中点击安装。</p>
<p>安装插件可能会失败，多试几次就好了，安装完记得重启Pod</p>
<table>
<thead>
<tr>
<th>插件名称</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>Git</td>
<td>用于拉取代码</td>
</tr>
<tr>
<td>Git Parameter</td>
<td>用于Git参数化构建</td>
</tr>
<tr>
<td>Pipeline</td>
<td>用于流水线</td>
</tr>
<tr>
<td>kubernetes</td>
<td>用于连接Kubernetes动态创建Slave代理</td>
</tr>
<tr>
<td>Config File Provider</td>
<td>用于存储kubectl用于连接k8s集群的kubeconfig配置文件</td>
</tr>
<tr>
<td>Gitlab</td>
<td>当提交代码或打开/更新合并请求时，此插件允许GitLab触发Jenkins中的构建。它还可以将构建状态发送回GitLab。</td>
</tr>
<tr>
<td>Gitlab Authentication plugin</td>
<td>GitLab身份验证插件提供了一种使用GitLab进行身份验证和授权以保护Jenkins的方法。</td>
</tr>
<tr>
<td>credential</td>
<td>账号密码管理插件</td>
</tr>
</tbody>
</table>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233541.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233541.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233541.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233541.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233541.png"
        title="img" /></p>
<h2 id="66-jenkins-在-k8s-中动态创建代理">6.6 jenkins 在 k8s 中动态创建代理</h2>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233619.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233619.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233619.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233619.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412233619.png"
        title="img" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414115808.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414115808.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414115808.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414115808.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414115808.png"
        title="img" /></p>
<h3 id="661-在-jenkins-中添加-kubernetes-">6.6.1 在 jenkins 中添加 kubernetes ☁️</h3>
<p>管理Jenkins-&gt;Manage Nodes and Clouds-&gt;configureClouds-&gt;Add</p>
<p>输入Kubernetes 地址： <a href="https://kubernetes.default/" target="_blank" rel="noopener noreffer">https://kubernetes.default</a> ，点击连接测试，测试通过的话，会显示k8s的版本信息</p>
<p>输入Jenkins 地址： <a href="http://jenkins.ops/" target="_blank" rel="noopener noreffer">http://jenkins.ops</a></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234304.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234304.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234304.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234304.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234304.png"
        title="image-20210412234304246" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234328.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234328.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234328.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234328.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234328.png"
        title="image-20210412234328449" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234355.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234355.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234355.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234355.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234355.png"
        title="image-20210412234355680" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234821.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234821.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234821.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234821.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210412234821.png"
        title="img" /></p>
<h3 id="662-构建-jenkins-slave-镜像">6.6.2 构建 jenkins-slave 镜像</h3>
<p>基于官方镜像提供的 jnlp-slave 使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">docker pull jenkins/jnlp-slave
docker tag jenkins/jnlp-slave:latest 192.168.110.239/library/jnlp-slave:latest
docker login 192.168.110.239
docker push 192.168.110.239/library/jnlp-slave:latest
</code></pre></td></tr></table>
</div>
</div><p>基于官方 alpine 镜像提供的Dockerfile  包使用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cd /data
git clone https://github.com/jenkinsci/docker-inbound-agent.git
cd docker-inbound-agent
cp 8/alpine/Dockerfile .
</code></pre></td></tr></table>
</div>
</div><p>修改 Dockerfile 为以下，主要添加 maven 和 kubectl（和 k8s 集群版本对应）</p>
<p>maven 修改为阿里云源：https://github.com/fxkjnj/kubernetes/blob/main/jenkins-for_kubernetes/jenkins-slave/settings.xml</p>
<p>kubectl 下载：curl -LO <a href="https://dl.k8s.io/release/v1.20.4/bin/linux/amd64/kubectl">https://dl.k8s.io/release/v1.20.4/bin/linux/amd64/kubectl</a></p>
<p>helm 下载：wget <a href="https://get.helm.sh/helm-v3.5.3-linux-amd64.tar.gz">https://get.helm.sh/helm-v3.5.3-linux-amd64.tar.gz</a> &amp;&amp; tar zxvf helm-v3.5.3-linux-amd64.tar.gz</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">ARG version=4.7-1-alpine
FROM jenkins/agent:$version

ARG version
LABEL Description=&#34;This is a base image, which allows connecting Jenkins agents via JNLP protocols&#34; Vendor=&#34;Jenkins project&#34; Version=&#34;$version&#34;

ARG user=jenkins

USER root

RUN sed -i &#39;s/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g&#39; /etc/apk/repositories &amp;&amp;\
    apk add maven git curl &amp;&amp;\
    rm -rf /var/cache/apk/*

COPY jenkins-agent /usr/local/bin/jenkins-agent
COPY settings.xml /etc/maven/settings.xml
COPY kubectl /usr/bin/
COPY helm /usr/bin/
RUN chmod +x /usr/bin/kubectl &amp;&amp;\
    chmod +x /usr/bin/helm &amp;&amp;\
    chmod +x /usr/local/bin/jenkins-agent &amp;&amp;\
    ln -s /usr/local/bin/jenkins-agent /usr/local/bin/jenkins-slave
    
USER ${user}

ENTRYPOINT [&#34;/usr/local/bin/jenkins-agent&#34;]
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#然后 
docker build . -t 192.168.110.239/library/jenkins-slave:4.7.1-alpine
docker push 192.168.110.239/library/jenkins-slave:4.7.1-alpine
</code></pre></td></tr></table>
</div>
</div><p>在jenkins 中创建一个流水线项目，测试jenkins-slave 是否功能</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414093048.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414093048.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414093048.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414093048.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414093048.png"
        title="image-20210414093048480" /></p>
<p>在pipeline 中 编写脚本，pipeline 脚本分为 声明式 和 脚本式</p>
<p>我这里写 声明式 脚本</p>
<p>需要注意的是，spec 中定义containers的名字一定要写jnlp</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">pipeline {
    agent {
        kubernetes {
            yaml &#39;&#39;&#39;
apiVersion: v1          
kind: Pod
metadata:
  name: jenkins-slave
spec:
  containers:
  - name: jnlp
    image: 192.168.110.239/library/jenkins-slave:4.7.1-alpine
&#39;&#39;&#39;

        }
    }
    stages {
        stage(&#39;测试&#39;) {
            steps {
                sh &#39;hostname&#39;
                sh &#39;mvn -version&#39;
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><p>点击Build New 按钮，开始构建</p>
<p>构建结束后，点击项目编号，可以查看jenkins 构建的日志</p>
<p>日志中可以看到 输出了主机名</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414094413.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414094413.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414094413.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414094413.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414094413.png"
        title="image-20210414094412922" /></p>
<h3 id="663-给-jenkins-slave-pod-添加存储卷以及挂载docker-命令到pod-中">6.6.3 给 Jenkins-Slave pod 添加存储卷，以及挂载docker 命令到Pod 中</h3>
<p>因为每次maven 打包会产生依赖的库文件，为了加快每次编译打包的速度，我们可以创建一个pvc 用来存储maven 每次打包产生的依赖文件。以及 我们需要将 k8s 集群 node 主机上的docker 命令挂载到Pod 中，用于镜像的打包 ，推送</p>
<p>直接创建pvc, 这里使用的动态补给的PV（直接使用上面以及创建好一个jenkins-nfs-client storageClass ）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cat &gt; jenkins-slave-pvc.yml &lt;&lt; EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mavencache
spec:
  storageClassName: &#34;jenkins-nfs-client&#34;
  accessModes:
    - ReadWriteMany     
  resources:
    requests:
      storage: 10Gi
EOF

kubectl apply -f jenkins-slave-pvc.yml -n ops
kubectl get pvc -n ops
</code></pre></td></tr></table>
</div>
</div><p>Jenkins-Slave pod yaml内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">apiVersion: v1          
kind: Pod
metadata:
  name: jenkins-slave
spec:
  containers:
  - name: jnlp
    image: docker push 192.168.110.239/library/jenkins-slave:4.7.1-alpine
    imagePullPolicy: Always
    volumeMounts:
      - name: docker-cmd
        mountPath: /usr/bin/docker
      - name: docker-sock
        mountPath: /var/run/docker.sock
      - name: maven-cache
        mountPath: /root/.m2

  volumes:
    - name: docker-cmd
      hostPath:
        path: /usr/bin/docker
    - name: docker-sock
      hostPath:
        path: /var/run/docker.sock
    - name: maven-cache
      persistentVolumeClaim:
        claimName: mavencache       
</code></pre></td></tr></table>
</div>
</div><p>##6.7 jenkins 在 kubernetes 中部署 tomcat 示例</p>
<p>上面的harbor镜像仓库，gitlab 代码仓库，jenkins 发布平台都已经部署完成，现在我们需要使用Jenkins在Kubernetes中持续部署一个无状态的tomcat 应用</p>
<p>具体流程如下：</p>
<ol>
<li>拉取代码 git checkout，我这里直接将 github 的代码 import 到 gitlab 里面了，具体可以参考：<a href="https://zhaouncle.com/k8s%E7%8E%AF%E5%A2%83-gitlab%E5%AE%89%E8%A3%85/" target="_blank" rel="noopener noreffer">Gitlab安装</a></li>
<li>编译代码 mvn clean</li>
<li>打包镜像 并上传镜像仓库</li>
<li>使用yaml 模板文件部署用镜像仓库中的镜像，kubectl 命令部署pod</li>
<li>开发测试</li>
</ol>
<p>###6.7.1 生成拉取git 代码的Pipeline 脚本</p>
<p>登陆jenkins 控制器，使用凭据的方式保存 git 账户信息 和 harbor 账户信息</p>
<p>用于jenkins 从gitlab 中拉取代码</p>
<p>Manage Jenkins -&gt; Manage Credentials -&gt; 全局凭据 (unrestricted) -&gt; Add Credentials</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414105510.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414105510.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414105510.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414105510.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414105510.png"
        title="image-20210414105510716" /></p>
<p>选择Kind 类型 为 username with passwd</p>
<p>输入账户名，密码</p>
<p>添加一个描述信息</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415133620.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415133620.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415133620.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415133620.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415133620.png"
        title="image-20210415133619944" /></p>
<p>也可以使用 access token 的方式保存 gitlab 访问权限</p>
<p>Manage Jenkins -&gt; Configure System -&gt; Gitlab</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414111853.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414111853.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414111853.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414111853.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414111853.png"
        title="image-20210414111852988" /></p>
<p>然后点击一下“Test Connection” 测试为“Success” 状态，则成功了。</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114758.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114758.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114758.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114758.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114758.png"
        title="image-20210414114758590" /></p>
<p>gitlab创建 access token，授予 <strong>api</strong> 权限</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114703.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114703.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114703.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114703.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414114703.png"
        title="image-20210414114703498" /></p>
<h3 id="创建-jenkins-job">创建 jenkins job</h3>
<p>使用pipeline 生成 git 拉取代码的语法</p>
<p>jenkins 官方提供一个pipeline 语法的生成器</p>
<p>任意创建一个流水线项目</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png"
        title="image-20210414164313915" /></p>
<p>在pipeline 选项那里点击 ， pipeline Syntax</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414164444.png"
        title="image-20210414164412677" /></p>
<p>点击片段生成器，在sample step 下拉选项框 中 找到 checkout: check out from version control</p>
<p>输入Repository URL(代码仓库地址):   http://192.168.110.238/root/tomcat-java-demo.git</p>
<p>点击Credentials 选择 刚刚创建的git 的用户凭证</p>
<p>最后点击 Generate Pipeline Script 生产pipeline 语法</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414165855.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414165855.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414165855.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414165855.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210414165855.png"
        title="image-20210414165854955" /></p>
<p>也就是 下面这段话,有了这个我们就可以在jenkins 上去拉取仓库里的代码了</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">checkout([$class: &#39;GitSCM&#39;, branches: [[name: &#39;*/master&#39;]], extensions: [], userRemoteConfigs: [[credentialsId: &#39;gitlab-238&#39;, url: &#39;http://192.168.110.238/root/tomcat-java-demo.git&#39;]]])
</code></pre></td></tr></table>
</div>
</div><p>###编译代码 mvn clean</p>
<p>在上面构建Jenkins-Slave镜像的时候，我们已经在镜像里安装了maven 编译代码的软件</p>
<p>只需要代码的路径下执行一条命令即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">mvn</span> <span class="nx">clean</span> <span class="kn">package</span> <span class="o">-</span><span class="nx">Dmaven</span><span class="p">.</span><span class="nx">skip</span><span class="p">.</span><span class="nx">test</span><span class="p">=</span><span class="kc">true</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="测试案例-tomcat-java-demo-gitlim-的-dockerfile">测试案例 tomcat-java-demo gitlim 的 Dockerfile</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">FROM tomcat:8-jdk8
LABEL maintainer www.ctnrs.com
RUN rm -rf /usr/local/tomcat/webapps/*
ADD target/*.war /usr/local/tomcat/webapps/ROOT.war 
</code></pre></td></tr></table>
</div>
</div><h3 id="授权创建-kubeconfig-文件并保存在-jenkins-中">授权创建 kubeconfig 文件，并保存在 jenkins 中</h3>
<p>准备好创建K8S 集群的那一套 ca证书</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@proxy k8s]# cd /data/ssl/
[root@proxy ssl]# ls 
ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem
</code></pre></td></tr></table>
</div>
</div><p>生成请求证书文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cat &gt;admin-csr.json &lt;&lt;EOF
{
  &#34;CN&#34;: &#34;admin&#34;,
  &#34;hosts&#34;: [],
  &#34;key&#34;: {
    &#34;algo&#34;: &#34;rsa&#34;,
    &#34;size&#34;: 2048
  },
  &#34;names&#34;: [
    {
      &#34;C&#34;: &#34;CN&#34;,
      &#34;L&#34;: &#34;BeiJing&#34;,
      &#34;ST&#34;: &#34;BeiJing&#34;,
      &#34;O&#34;: &#34;system:masters&#34;,
      &#34;OU&#34;: &#34;System&#34;
    }
  ]
}
EOF
</code></pre></td></tr></table>
</div>
</div><p>安装cfssl 生成证书工具</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">curl -L https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -o /usr/local/bin/cfssl
curl -L https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -o /usr/local/bin/cfssljson
curl -L https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -o /usr/local/bin/cfssl-certinfo
chmod +x /usr/local/bin/cfssl*
</code></pre></td></tr></table>
</div>
</div><p>生成证书</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@proxy ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin
2021/04/15 09:07:41 [INFO] generate received request
2021/04/15 09:07:41 [INFO] received CSR
2021/04/15 09:07:41 [INFO] generating key: rsa-2048
2021/04/15 09:07:42 [INFO] encoded CSR
2021/04/15 09:07:42 [INFO] signed certificate with serial number 707063479988721234464365406719482455967000883299
2021/04/15 09:07:42 [WARNING] This certificate lacks a &#34;hosts&#34; field. This makes it unsuitable for
websites. For more information see the Baseline Requirements for the Issuance and Management
of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);
specifically, section 10.2.3 (&#34;Information Requirements&#34;).
</code></pre></td></tr></table>
</div>
</div><p>查看生成的证书</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@proxy ssl]# ls admin*
admin.csr  admin-csr.json  admin-key.pem  admin.pem
</code></pre></td></tr></table>
</div>
</div><p>生成kubeconfig授权文件：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">kubectl config set-cluster kubernetes   --certificate-authority=ca.pem   --embed-certs=true   --server=https://192.168.110.235:6443

#设置用户项中cluster-admin用户证书认证字段
kubectl config set-credentials  cluster-admin   --client-key=admin-key.pem   --client-certificate=admin.pem   --embed-certs=true

#设置默认上下文
kubectl config set-context kubernetes   --cluster=kubernetes   --user=cluster-admin

#设置当前环境的default
kubectl config use-context kubernetes
</code></pre></td></tr></table>
</div>
</div><p>查看生成的config文件</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 ssl]# cat /root/.kube/config 
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR2akNDQXFhZ0F3SUJBZ0lVQ2xzU2RlK1lnRTNDdkRrd1ZhUkZ5c3dZL0Zrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1pURUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeEREQUtCZ05WQkFvVEEyczRjekVQTUEwR0ExVUVDeE1HVTNsemRHVnRNUk13RVFZRFZRUURFd3ByCmRXSmxjbTVsZEdWek1CNFhEVEl4TURRd05EQXlNRE13TUZvWERUSTJNRFF3TXpBeU1ETXdNRm93WlRFTE1Ba0cKQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbGFXcHBibWN4RERBSwpCZ05WQkFvVEEyczRjekVQTUEwR0ExVUVDeE1HVTNsemRHVnRNUk13RVFZRFZRUURFd3ByZFdKbGNtNWxkR1Z6Ck1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBMVYzSDVCaUorQkJjRXlwT3lxZjYKbDVvMTJLNFZOM3JvcnNXL1M1cjhnNWFic2RyZFdCczhremlybnp0VVVlZ0RLMXY3T3B2U0xyVWMzQWRVS2xOZApWRkgrTnpNS1Q0QmZ6UHAxR0w0YWZjVFdKMHQyRUpKNU9rT3BYMkNDdURkd1hQYWJUY0FlVWw5NURsWmdzdUNkCmx3bXFkQzM0dlZqUzRZVHJQekxBOVJYN2NPSkJWRlI1Y2VYYloyS0s2L0ZHSDY1TkJGRWU5NVF6bDhHYVBncTMKa05pNDBUYzdPYVBKa1VsQXhmbG9hTkI3eHdVRnMzTk4yS0cxeTdjWC9MdTZWN0Y5YnZCNkNkZVhvblJxTTUvdgp4cGo1MjlEMUthc3JmcHpuNFNEMWR6dE5tVkgvMWN6ZHI2bDVqQURFSFZhQWFVb0xIWVRqRU4vUisyL0VJZlBLCjN3SURBUUFCbzJZd1pEQU9CZ05WSFE4QkFmOEVCQU1DQVFZd0VnWURWUjBUQVFIL0JBZ3dCZ0VCL3dJQkFqQWQKQmdOVkhRNEVGZ1FVTytFWjI0SmNIMnhkTHR5bS9BWFQ5aTg2Sm53d0h3WURWUjBqQkJnd0ZvQVVPK0VaMjRKYwpIMnhkTHR5bS9BWFQ5aTg2Sm53d0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dFQkFCVTRkOXBkbTNhL1NUeGNBMXJ1CllQazhjNVVmL3VzeUlKWlZmMlRrYnpHa3VQUU96SGdMbXpuajBmampmYjQ2YUZHalBIZGRFbERieWZyRnZ1aGIKSDFwaWVXaUNCVkFUM1FzeDNUMGg4RlR1dXlDbGpsT3hUNVo5VzJWRS96dHRpbGpIb1hqeEkxejJFZHVPSE80TwpSei9EVVZHSENYWndoVDZhR1psRmhhUUtUNjJKQWRqTTVKME9mSVRWNkQyR2J3QlUzQ0RwMEdORlQwaTZqS0hMCkVLb3ladis1Vjd3ckNoRG1oUTg0WkwwRURtNmROTHNXaDZXbDBYaUJGUEd1UFN2YW96cUlYRGlRR0VWM0xrWE4Kb0prVHFkNXhOdnQzRUh6RlB1RytWMVFmdzRMd3J6ZzZZMG4rZ0tXR2xJWkxLN0Q4VmtuY1NNTnFJOUJ4eFU2TApmWG89Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    server: https://192.168.110.235:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: admin
  name: default
- context:
    cluster: kubernetes
    user: cluster-admin
  name: kubernetes
current-context: kubernetes
kind: Config
preferences: {}
users:
- name: admin
  user:
    client-certificate: /opt/kubernetes/ssl/admin.pem
    client-key: /opt/kubernetes/ssl/admin-key.pem
- name: cluster-admin
  user:
    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQzVENDQXNXZ0F3SUJBZ0lVZTluU3IvK3NWWEVMWnBVSVo1ZjFReFYyOEdNd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1pURUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeEREQUtCZ05WQkFvVEEyczRjekVQTUEwR0ExVUVDeE1HVTNsemRHVnRNUk13RVFZRFZRUURFd3ByCmRXSmxjbTVsZEdWek1CNFhEVEl4TURReE5UQXhNRE13TUZvWERUTXhNRFF4TXpBeE1ETXdNRm93YXpFTE1Ba0cKQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFVcHBibWN4RURBT0JnTlZCQWNUQjBKbGFVcHBibWN4RnpBVgpCZ05WQkFvVERuTjVjM1JsYlRwdFlYTjBaWEp6TVE4d0RRWURWUVFMRXdaVGVYTjBaVzB4RGpBTUJnTlZCQU1UCkJXRmtiV2x1TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF5K29tTVNXZ2pLdlUKMHY1K3Eza00xckdiZWlFYXN6c09rM1ROakR0Qy8xQlVYQ1VCOEJMWEFQNDNqaTRNQndrcmVlUVBHeEIwSy90YwpDbHVwTzVtL1lSRFlOcng3NVpJVlZKZnlHWVhPRW1WNWtSY2FTRUF4UUs2Q0FSanJxTGY3QkYwOWs4cTRXV3IzCkVMYS83TE5nWUhRdzR3d3ZSYmVIR1FiOGVxL3VhUTRJTFVHT1NZcTlDcmdOa3gvMms0TDV3NkNWSnZnMk8vYnoKbk04YTkwMHdhWTZBTTVvb2pFYXF4MW5BSW9FMlFVVnpXbHpJTDRMSCtXZnMxcVNHM1VicFlzdEI4VUJVZzREWQpxclpEaldoa2lUb0MwN0x4OVlSdXJoUHpyRnJQT2Y4QU53d0ZLL1NWRms2emkzbk4wSStWVFdqYmk1TnVSTUVHCnpjQWFWSXRNWVFJREFRQUJvMzh3ZlRBT0JnTlZIUThCQWY4RUJBTUNCYUF3SFFZRFZSMGxCQll3RkFZSUt3WUIKQlFVSEF3RUdDQ3NHQVFVRkJ3TUNNQXdHQTFVZEV3RUIvd1FDTUFBd0hRWURWUjBPQkJZRUZNNW1nM2VyaHF4UwpCdW9JSXBpakR1alQzOFJqTUI4R0ExVWRJd1FZTUJhQUZEdmhHZHVDWEI5c1hTN2NwdndGMC9Zdk9pWjhNQTBHCkNTcUdTSWIzRFFFQkN3VUFBNElCQVFBdDhlMnVpTDk3TlZ6S21KU1o3eThFYWFmWGJOcWtVVUpNeXR5dW8vYTcKVS82WjEvemJMQTRBbXNvdTM2WFlMNkIycGxMWitwUDdSNStiZTRmMWdMRk5nTENuZWFpRTJhYkFjdzFSYi9GZwpsN2o1amN3Y2huWjRZeHpmdnJ5U0JvS0NGTFEvZi9ob2tUZE1kQjdMekVDZzZnZE85UzJ3NVBXbEtPNnZKWVdrClVheTlBb1N4MjE2clljcDNOUk95TkpTbHphWEFpUVMvRlRDZTdYUmFxSCtmWmF6NS80QmhNNDRjTW8vcjZwYU4KUlhPVlAwYVdscG1kRVAyN3hkT2MyT09zdzlsQXlmSHk0MDUzTC9rMlppZGJRVk1POU52Vkc4KzdpNktaVmViNwpqSUlqRmFjZUlZaHcwZlE3bERtektES09hdDcwM2xsSDlmQW9IVjVNdFpCMAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
    client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFcEFJQkFBS0NBUUVBeStvbU1TV2dqS3ZVMHY1K3Eza00xckdiZWlFYXN6c09rM1ROakR0Qy8xQlVYQ1VCCjhCTFhBUDQzamk0TUJ3a3JlZVFQR3hCMEsvdGNDbHVwTzVtL1lSRFlOcng3NVpJVlZKZnlHWVhPRW1WNWtSY2EKU0VBeFFLNkNBUmpycUxmN0JGMDlrOHE0V1dyM0VMYS83TE5nWUhRdzR3d3ZSYmVIR1FiOGVxL3VhUTRJTFVHTwpTWXE5Q3JnTmt4LzJrNEw1dzZDVkp2ZzJPL2J6bk04YTkwMHdhWTZBTTVvb2pFYXF4MW5BSW9FMlFVVnpXbHpJCkw0TEgrV2ZzMXFTRzNVYnBZc3RCOFVCVWc0RFlxclpEaldoa2lUb0MwN0x4OVlSdXJoUHpyRnJQT2Y4QU53d0YKSy9TVkZrNnppM25OMEkrVlRXamJpNU51Uk1FR3pjQWFWSXRNWVFJREFRQUJBb0lCQUVzUGVkZUZmai9KMEtHSwpSSjVpQkxQUzFPUno0eHd1bFFMNmI5ODZ3VUt5RXh1SUU5cUhWTlZzdm81N3JMbTZTbUtuN0ZlT0N2VlZwVis2CnRlVFdoM2YzZDE5T3FseXJGV2I2TjRmbGxTRjRjUE5UaWIwbXcvcUhRaHVkVE1IaVYyZ1gybDdZdEZ0VjRIUXEKa1NOVU5Cbk5LMkdvVG81ZkxEK3VMcW9Lc0x2Q1lrZFlsZTRudG5tSkhoR25LbnlVTU1OVGVEMVU0bTZMM0JLYwpRb3ZJTy84NVlySCswa2pkVms2OWYwNGMyUks0bVRLNDBSa1VwbXVtWmtVeUc3ZFNad0VMOXQ3ZmkxSENHV0xyCmFuSkF6OEc1NVlvbTIyTWdMcWpWRVZtR3pQRjhabGNhUnBlZmdmTEFNYVE5RlNCcndRaGtjNm5ranMxSFpyYzIKYXk3bnFmRUNnWUVBM3kyT3ZBZDhCNHVVbW8ycVZYbkZvaEU1S2g0S3VjUWpWMUFZWVRaVEhwaFVBeEQ0S3psRwpoUXFLZGR4WUxRczEycXRiRXlWWkVkR1NJS2x6VkpqUEwvSkRlemc0Y05MVHdRZXhYM0hhWklMdDRDSzFubUdPCjdpeHJTRitqaUZJMkFEdndhbzFCU1d6bDdodzllOFl0V0g5a1Y4S0QweDZ2Yi84cHV0dURsNDhDZ1lFQTZlZFkKaGJKRlZRQWo2NkNYYW5rM3Z4cVJPNzF4d1RKR0JWU2wzSnBISFNnUG81bGlab01ZOGdrc3NlOUUyUDdjazFlcgp5Nis3Uk5GblZFUmRTaHVSZ2ZkN1FWSzFBa2ZtcVBjNTVLOG02cVdLMW9wUTJMYmE5QlJ4MkxEWS94VFptVU41Cldpb28vRUxnVEg5V011a2pXNGo3Zys0b1dISEZleVZoVksxV1pROENnWUVBdU5SK0ZYTU5ZU0pVRy91ZlNkTGoKdm1rTk1yaFdvYXF5cWlrSFI5czUwMmpNaXcyT3VoMWhMZVdnN2lOaVUwdXBla1BYMVc5azZNRHJpR2xOdm80ZgphTkgyMlNHaWZLM2QrVXRwdG1ZUVBKWENjNUhMWURQanI1VFI5TXBnSVJJVTd2UzFFMG1RL0VKWDJtOUE3RFVnCmNONXdOODQ4WnFoUEd5M3pYWEZXOWprQ2dZQXc1eU9FNEY3S2hMcjkycGVOdFVaSWVEK0JJL3lTamZaQnl3N2EKYm84THM0S0JpK0ljMksvd2VxYVRsUmpwM1c4MGh4SHVCaEc3TTZUTTQzWTF0a25YeUd4R25nb21MZTQxeVdxYgpPMXVCbDViTmdDR2pEYWY5ZkFESmMwQUxKTXJSMWwrYTBGRzlYQ1lWR0ZKblZvTUQ4a0hUdFlsTjVJdUxVYWRsCjBzL0xWUUtCZ1FETTFwQlk2ME9VT1Zxenc4WG1QTGtuOWV4dlhicm9EQmNrRVd6WTlyczRpRFd2SnFyR21KdEIKVW9KYXlPaC9BcTd6bGFpK0FVYlpjMjNtN3VrSnRMdlFLY2NlVWZFbzVYVkc5NVM3M21QVVkzYXBabXlXZmNtTgpzOUpHK3IyVk9WREFJa0lrcGlWVW1NR0xwb1RXNTdxTHhsYzJQR0sxbk9HcnJReDQ2anhrZEE9PQotLS0tLUVORCBSU0EgUFJJVkFURSBLRVktLS0tLQo=
</code></pre></td></tr></table>
</div>
</div><p>使用&ndash;kubeconfig= 指定生成的config文件路径，测试连接K8S集群</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 ssl]# kubectl --kubeconfig=/root/.kube/config get nodes
NAME          STATUS   ROLES    AGE   VERSION
k8s-master1   Ready    &lt;none&gt;   10d   v1.20.4
k8s-node1     Ready    &lt;none&gt;   10d   v1.20.4
k8s-node2     Ready    &lt;none&gt;   10d   v1.20.4
</code></pre></td></tr></table>
</div>
</div><h3 id="把生成的kubeconfig配置文件存放在jenkins-中">把生成的kubeconfig配置文件存放在jenkins 中</h3>
<p>Manage Jenkins -&gt; Managed files -&gt; Add a new Config -&gt; Custom file（自定义文件）</p>
<p>输入 Name： k8s-kubeconfig</p>
<p>把生成的kubeconfig 文件内容 复制到 Content 文本框中</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091854.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091854.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091854.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091854.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091854.png"
        title="image-20210415091854554" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091911.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091911.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091911.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091911.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091911.png"
        title="image-20210415091911829" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091949.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091949.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091949.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091949.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415091949.png"
        title="image-20210415091949467" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415092052.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415092052.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415092052.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415092052.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415092052.png"
        title="image-20210415092052757" /></p>
<p>将自签名的 harbor 证书的 key/crt/cert 也同样导入到 Managed files</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210417151920.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210417151920.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210417151920.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210417151920.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210417151920.png"
        title="image-20210417151920204" /></p>
<h3 id="把managed-files-中的配置文件-转换成pipeline-语法">把Managed files 中的配置文件 转换成pipeline 语法</h3>
<p>直接打开 http://192.168.110.235:30008/pipeline-syntax/就可以了，不需要创建 job</p>
<p>点击片段生成器，Sample Step 下拉选项框中 选择 configFileProvider: Provide Configuration files</p>
<p>在File 下拉选项框中，选中 刚刚创建的 自定义文件 k8s-kubeconfig</p>
<p>在Target 中 输入 admin.kubeconfig (target 表示把 自定义的文件 挂载到 jenkin-slave 镜像的什么路径下，这边定义了文件名称，就相当于把 admin.kubeconfig 文件 放在 jenkin-slave 镜像 的默认工作路径下/home/jenkins/agent/workspace/XX 下面 )</p>
<p>最后点击 Generate Pipeline Script 生产pipeline 语法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">configFileProvider([configFile(fileId: &#39;ac20bd78-327d-41b1-952f-ad15bc07e4ba&#39;, targetLocation: &#39;admin.kubeconfig&#39;)]) {
    // some block
}
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415093714.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415093714.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415093714.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415093714.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415093714.png"
        title="image-20210415093714811" /></p>
<h3 id="编写标准的deployyaml-模板">编写标准的deploy.yaml 模板</h3>
<p>本项目是 使用Jenkins在Kubernetes中持续部署一个无状态的tomcat pod 应用；涉及到 deployment 控制器 以及采用NodePort 的方式去 访问pod</p>
<p>deployment.yaml 和 service.yaml 我把他合并在一个deploy.yaml 文件中</p>
<p>另外deploy.yaml 文件 必须和 项目的代码 在同一个路径下（否则kubectl 无法指定yaml 文件就 无法创建pod）</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cat &gt; deploy.yaml &lt;&lt; EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tomcat-java-demo
spec:
  replicas: REPLICAS
  selector:
    matchLabels:
      project: www
      app: tomcat-java-demo
  template:
    metadata:
      labels:
        project: www
        app: tomcat-java-demo
    spec:
      imagePullSecrets:
      - name: SECRET_NAME
      containers:
      - image: IMAGE_NAME
        name: tomcat-java-demo
        resources:
          requests:
            cpu: 0.5
            memory: 500Mi
          limits: 
            cpu: 1
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 50
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /
            port: 8080
          initialDelaySeconds: 50
          periodSeconds: 10


---
apiVersion: v1
kind: Service
metadata:
  name: tomcat-java-demo 
spec:
  selector:
    project: www
    app: tomcat-java-demo
  type: NodePort
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
EOF
</code></pre></td></tr></table>
</div>
</div><h3 id="在k8s-集群中创建sercret-用于连接harbor仓库用于k8s创建pod时-拉取镜像">在K8S 集群中创建sercret 用于连接Harbor仓库（用于K8S创建POD时 拉取镜像）</h3>
<p>备注：</p>
<p>应用启动过程中可能需要一些敏感信息，比如访问数据库的用户名密码或者秘钥。将这些信息直接保存在容器镜像中显然不妥，Kubernetes 提供的解决方案是 Secret。</p>
<p>Secret 会以密文的方式存储数据，避免了直接在配置文件中保存敏感信息。Secret 会以 Volume 的形式被 mount 到 Pod，容器可通过文件的方式使用 Secret 中的敏感数据；此外，容器也可以环境变量的方式使用这些数据。</p>
<p>找一台登陆过的Harbor 的 node 的节点，查看 cat ~/.docker/config.json 问价里的内容</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 ssl]# cat ~/.docker/config.json 
{
        &#34;auths&#34;: {
                &#34;192.168.110.239&#34;: {
                        &#34;auth&#34;: &#34;YWRtaW46SGFyYm9yMTIzNDU=&#34;
                }
        },
        &#34;HttpHeaders&#34;: {
                &#34;User-Agent&#34;: &#34;Docker-Client/19.03.9 (linux)&#34;
        }
}
</code></pre></td></tr></table>
</div>
</div><p>使用 base64 对 ~/.docker/config.json 文件 进行编码</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 ssl]# cat ~/.docker/config.json | base64 |tr -d &#34;\n&#34;
ewoJImF1dGhzIjogewoJCSIxOTIuMTY4LjExMC4yMzkiOiB7CgkJCSJhdXRoIjogIllXUnRhVzQ2U0dGeVltOXlNVEl6TkRVPSIKCQl9Cgl9LAoJIkh0dHBIZWFkZXJzIjogewoJCSJVc2VyLUFnZW50IjogIkRvY2tlci1DbGllbnQvMTkuMDMuOSAobGludXgpIgoJfQp9
</code></pre></td></tr></table>
</div>
</div><p>创建secret yaml文件</p>
<p><strong>Tips</strong>：注意base64 的结果要写成一行</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">cat &gt; registry-pull-secret.yaml &lt;&lt; EOF
apiVersion: v1
kind: Secret
metadata:
  name: secret-dockercfg
type: kubernetes.io/dockerconfigjson
data:
  .dockerconfigjson: |
        ewoJImF1dGhzIjogewoJCSIxOTIuMTY4LjExMC4yMzkiOiB7CgkJCSJhdXRoIjogIllXUnRhVzQ2U0dGeVltOXlNVEl6TkRVPSIKCQl9Cgl9LAoJIkh0dHBIZWFkZXJzIjogewoJCSJVc2VyLUFnZW50IjogIkRvY2tlci1DbGllbnQvMTkuMDMuOSAobGludXgpIgoJfQp9
        
EOF        
</code></pre></td></tr></table>
</div>
</div><p>在 指定的 ns 命名空间下 执行 kubectl apply 创建 Secret：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">for i in {prod,dev};do kubectl create namespace $i;done
for i in {prod,dev};do kubectl  apply -f registry-pull-secret.yaml -n $i;done

</code></pre></td></tr></table>
</div>
</div><p>查看创建的 secret</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 ssl]# for i in {prod,dev};do kubectl get secret -n $i;done
NAME                  TYPE                                  DATA   AGE
default-token-nhtmq   kubernetes.io/service-account-token   3      51m
secret-dockercfg      kubernetes.io/dockerconfigjson        1      51m
NAME                  TYPE                                  DATA   AGE
default-token-p44zj   kubernetes.io/service-account-token   3      51m
secret-dockercfg      kubernetes.io/dockerconfigjson        1      51m
</code></pre></td></tr></table>
</div>
</div><h3 id="定义环境变量使用参数化构建修改deployyaml文件">定义环境变量，使用参数化构建，修改deploy.yaml文件</h3>
<p>需要提前定义好的环境变量：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">//定义harbor的地址
def registry = &#34;192.168.110.239&#34;

// 项目，BUILD_NUMBER jenkins 内置变量，jenkins 构建编号
def project = &#34;java&#34;
def app_name = &#34;tomcat-java-demo&#34;
def image_name = &#34;${registry}/${project}/${app_name}:${BUILD_NUMBER}&#34;
def git_address = &#34;http://192.168.110.238/root/tomcat-java-demo.git&#34;

// 认证
//k8s 连接harbor 证书
def secret_name = &#34;registry-pull-secret&#34;

//jenkins中定义docker连接harbor的用户密码凭证，全局凭据里面的 ID
def docker_registry_auth = &#34;5079d562-6f41-455a-9f7d-5a7bd9a17a44&#34;

//jenkins中定义git连接gitlab的用户密码凭证，全局凭据里面的 ID
def git_auth = &#34;0ddfe45b-a247-492c-a71b-2ceed7704663&#34;

//jenkins中Config File Provider插件 定义的kubeconfig 文件内容
def k8s_auth = &#34;ac20bd78-327d-41b1-952f-ad15bc07e4ba&#34;
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134448.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134448.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134448.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134448.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134448.png"
        title="image-20210415134448038" /></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134352.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134352.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134352.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134352.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210415134352.png"
        title="image-20210415134352169" /></p>
<p>参数化构建过程中，需要交互的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">发布分支(prod,dev)
副本数（1,3,5,7）
命名空间（prod,dev）
</code></pre></td></tr></table>
</div>
</div><p>一个标准的deploy.yaml模板文件，需要把修改的内容：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">#修改deploy.yaml 中镜像名称
sed -i &#39;s#IMAGE_NAME#${image_name}#&#39; deploy.yaml

#修改deploy.yaml 中k8s连接harbor连接的secret
sed -i &#39;s#SECRET_NAME#${secret_name}#&#39; deploy.yaml

#修改deploy.yaml 中副本的数量
sed -i &#39;s#REPLICAS#${ReplicaCount}#&#39; deploy.yaml

#指定pod 创建在哪个命名空间下
kubectl apply -f deploy.yaml -n ${Namespace} --kubeconfig=admin.kubeconfig  
</code></pre></td></tr></table>
</div>
</div><p>pipeline中引用示例：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">//参数化构建
parameters {    
        gitParameter branch: &#39;&#39;, branchFilter: &#39;.*&#39;, defaultValue: &#39;master&#39;, description: &#39;选择发布的分支&#39;, name: &#39;Branch&#39;, quickFilterEnabled: false, selectedValue: &#39;NONE&#39;, sortMode: &#39;NONE&#39;, tagFilter: &#39;*&#39;, type: &#39;PT_BRANCH&#39;
        choice (choices: [&#39;1&#39;, &#39;3&#39;, &#39;5&#39;, &#39;7&#39;], description: &#39;副本数&#39;, name: &#39;ReplicaCount&#39;)
        choice (choices: [&#39;prod&#39;,&#39;dev&#39;], description: &#39;命名空间&#39;, name: &#39;Namespace&#39;)
    }
    

//部署pod需要修改的内容
sh &#34;&#34;&#34;
sed -i &#39;s#IMAGE_NAME#${image_name}#&#39; deploy.yaml
sed -i &#39;s#SECRET_NAME#${secret_name}#&#39; deploy.yaml
sed -i &#39;s#REPLICAS#${ReplicaCount}#&#39; deploy.yaml
kubectl apply -f deploy.yaml -n ${Namespace} --kubeconfig=admin.kubeconfig  
&#34;&#34;&#34;
</code></pre></td></tr></table>
</div>
</div><h3 id="heading"></h3>
<h2 id="完整的pipeline-流水线-脚本">完整的pipeline 流水线 脚本</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// 公共
</span><span class="c1"></span><span class="nx">def</span> <span class="nx">registry</span> <span class="p">=</span> <span class="s">&#34;192.168.110.239&#34;</span>
<span class="c1">// 项目，BUILD_NUMBER jenkins 内置变量，jenkins 构建编号
</span><span class="c1"></span><span class="nx">def</span> <span class="nx">project</span> <span class="p">=</span> <span class="s">&#34;java&#34;</span>
<span class="nx">def</span> <span class="nx">app_name</span> <span class="p">=</span> <span class="s">&#34;tomcat-java-demo&#34;</span>
<span class="nx">def</span> <span class="nx">image_name</span> <span class="p">=</span> <span class="s">&#34;${registry}/${project}/${app_name}:${BUILD_NUMBER}&#34;</span>
<span class="nx">def</span> <span class="nx">git_address</span> <span class="p">=</span> <span class="s">&#34;http://192.168.110.238/root/tomcat-java-demo.git&#34;</span>
<span class="c1">// 认证
</span><span class="c1">//k8s 连接harbor 证书
</span><span class="c1"></span><span class="nx">def</span> <span class="nx">secret_name</span> <span class="p">=</span> <span class="s">&#34;registry-pull-secret&#34;</span>

<span class="c1">//jenkins中定义docker连接harbor的用户密码凭证，全局凭据里面的 ID
</span><span class="c1"></span><span class="nx">def</span> <span class="nx">docker_registry_auth</span> <span class="p">=</span> <span class="s">&#34;5079d562-6f41-455a-9f7d-5a7bd9a17a44&#34;</span>

<span class="c1">//jenkins中定义git连接gitlab的用户密码凭证，全局凭据里面的 ID
</span><span class="c1"></span><span class="nx">def</span> <span class="nx">git_auth</span> <span class="p">=</span> <span class="s">&#34;0ddfe45b-a247-492c-a71b-2ceed7704663&#34;</span>

<span class="c1">//jenkins中Config File Provider插件 定义的kubeconfig 文件内容
</span><span class="c1"></span><span class="nx">def</span> <span class="nx">k8s_auth</span> <span class="p">=</span> <span class="s">&#34;ac20bd78-327d-41b1-952f-ad15bc07e4ba&#34;</span>

<span class="nx">pipeline</span> <span class="p">{</span>
    <span class="nx">agent</span> <span class="p">{</span>
        <span class="nx">kubernetes</span> <span class="p">{</span>
            <span class="nx">yaml</span> <span class="sc">&#39;&#39;&#39;</span>
<span class="nx">apiVersion</span><span class="p">:</span> <span class="nx">v1</span>          
<span class="nx">kind</span><span class="p">:</span> <span class="nx">Pod</span>
<span class="nx">metadata</span><span class="p">:</span>
  <span class="nx">name</span><span class="p">:</span> <span class="nx">jenkins</span><span class="o">-</span><span class="nx">slave</span>
<span class="nx">spec</span><span class="p">:</span>
  <span class="c1">// 我的 jenkins-slave 不是用 root 用户运行的，查过 root 的 uid 在 docker 容器内部是 0，所以在执行 k8s yml 的时候选择指定 uid=0 的 root 用户执行命令行工具，否则会报权限错误
</span><span class="c1"></span>  <span class="nx">securityContext</span><span class="p">:</span>  
    <span class="nx">runAsUser</span><span class="p">:</span> <span class="mi">0</span>
    <span class="nx">runAsGroup</span><span class="p">:</span> <span class="mi">0</span>
  <span class="nx">containers</span><span class="p">:</span>
  <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">jnlp</span>
    <span class="nx">image</span><span class="p">:</span> <span class="err">$</span><span class="p">{</span><span class="nx">registry</span><span class="p">}</span><span class="o">/</span><span class="nx">library</span><span class="o">/</span><span class="nx">jenkins</span><span class="o">-</span><span class="nx">slave</span><span class="p">:</span><span class="mf">4.7.1</span><span class="o">-</span><span class="nx">alpine</span>
    <span class="nx">imagePullPolicy</span><span class="p">:</span> <span class="nx">Always</span>
    <span class="nx">volumeMounts</span><span class="p">:</span>
      <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">docker</span><span class="o">-</span><span class="nx">cmd</span>
        <span class="nx">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">docker</span>
      <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">docker</span><span class="o">-</span><span class="nx">sock</span>
        <span class="nx">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="kd">var</span><span class="o">/</span><span class="nx">run</span><span class="o">/</span><span class="nx">docker</span><span class="p">.</span><span class="nx">sock</span>
      <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">maven</span><span class="o">-</span><span class="nx">cache</span>
        <span class="nx">mountPath</span><span class="p">:</span> <span class="o">/</span><span class="nx">root</span><span class="o">/</span><span class="p">.</span><span class="nx">m2</span>
    <span class="nx">securityContext</span><span class="p">:</span>
      <span class="nx">allowPrivilegeEscalation</span><span class="p">:</span> <span class="kc">false</span>
  <span class="nx">volumes</span><span class="p">:</span>
    <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">docker</span><span class="o">-</span><span class="nx">cmd</span>
      <span class="nx">hostPath</span><span class="p">:</span>
        <span class="nx">path</span><span class="p">:</span> <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">bin</span><span class="o">/</span><span class="nx">docker</span>
    <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">docker</span><span class="o">-</span><span class="nx">sock</span>
      <span class="nx">hostPath</span><span class="p">:</span>
        <span class="nx">path</span><span class="p">:</span> <span class="o">/</span><span class="kd">var</span><span class="o">/</span><span class="nx">run</span><span class="o">/</span><span class="nx">docker</span><span class="p">.</span><span class="nx">sock</span>
    <span class="o">-</span> <span class="nx">name</span><span class="p">:</span> <span class="nx">maven</span><span class="o">-</span><span class="nx">cache</span>
      <span class="nx">persistentVolumeClaim</span><span class="p">:</span>
        <span class="nx">claimName</span><span class="p">:</span> <span class="nx">mavencache</span>
<span class="sc">&#39;&#39;&#39;</span>
           
        <span class="p">}</span>
    <span class="p">}</span>
	 <span class="nx">parameters</span> <span class="p">{</span>    
        <span class="nx">gitParameter</span> <span class="nx">branch</span><span class="p">:</span> <span class="err">&#39;&#39;</span><span class="p">,</span> <span class="nx">branchFilter</span><span class="p">:</span> <span class="err">&#39;</span><span class="p">.</span><span class="o">*</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">defaultValue</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">master</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">description</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">选择发布的分支</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">Branch</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">quickFilterEnabled</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">selectedValue</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">NONE</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">sortMode</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">NONE</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">tagFilter</span><span class="p">:</span> <span class="sc">&#39;*&#39;</span><span class="p">,</span> <span class="kd">type</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">PT_BRANCH</span><span class="err">&#39;</span>
        <span class="nf">choice</span> <span class="p">(</span><span class="nx">choices</span><span class="p">:</span> <span class="p">[</span><span class="sc">&#39;1&#39;</span><span class="p">,</span> <span class="sc">&#39;3&#39;</span><span class="p">,</span> <span class="sc">&#39;5&#39;</span><span class="p">,</span> <span class="sc">&#39;7&#39;</span><span class="p">],</span> <span class="nx">description</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">副本数</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">ReplicaCount</span><span class="err">&#39;</span><span class="p">)</span>
        <span class="nf">choice</span> <span class="p">(</span><span class="nx">choices</span><span class="p">:</span> <span class="p">[</span><span class="err">&#39;</span><span class="nx">prod</span><span class="sc">&#39;,&#39;</span><span class="nx">dev</span><span class="err">&#39;</span><span class="p">],</span> <span class="nx">description</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">命名空间</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">Namespace</span><span class="err">&#39;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">stages</span> <span class="p">{</span>		
		<span class="nf">stage</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">拉取代码</span><span class="err">&#39;</span><span class="p">){</span>
            <span class="nx">steps</span> <span class="p">{</span>
                <span class="nf">checkout</span><span class="p">([</span><span class="err">$</span><span class="nx">class</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">GitSCM</span><span class="err">&#39;</span><span class="p">,</span> 
                <span class="nx">branches</span><span class="p">:</span> <span class="p">[[</span><span class="nx">name</span><span class="p">:</span> <span class="s">&#34;${params.Branch}&#34;</span><span class="p">]],</span> 
                <span class="nx">doGenerateSubmoduleConfigurations</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> 
                <span class="nx">extensions</span><span class="p">:</span> <span class="p">[],</span> <span class="nx">submoduleCfg</span><span class="p">:</span> <span class="p">[],</span> 
                <span class="nx">userRemoteConfigs</span><span class="p">:</span> <span class="p">[[</span><span class="nx">credentialsId</span><span class="p">:</span> <span class="s">&#34;${git_auth}&#34;</span><span class="p">,</span> <span class="nx">url</span><span class="p">:</span> <span class="s">&#34;${git_address}&#34;</span><span class="p">]]</span>
                <span class="p">])</span>
            <span class="p">}</span>
        <span class="p">}</span>
		
        <span class="nf">stage</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">代码编译</span><span class="err">&#39;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">steps</span> <span class="p">{</span>
                <span class="nx">sh</span> <span class="err">&#39;</span><span class="nx">mvn</span> <span class="nx">clean</span> <span class="kn">package</span> <span class="o">-</span><span class="nx">Dmaven</span><span class="p">.</span><span class="nx">skip</span><span class="p">.</span><span class="nx">test</span><span class="p">=</span><span class="kc">true</span><span class="err">&#39;</span>
                <span class="nx">sh</span> <span class="err">&#39;</span><span class="nx">ls</span> <span class="o">-</span><span class="nx">l</span> <span class="nx">target</span><span class="o">/</span><span class="err">&#39;</span>
                <span class="nx">sh</span> <span class="err">&#39;</span><span class="nx">pwd</span><span class="err">&#39;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nf">stage</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">构建镜像并推送仓库</span><span class="err">&#39;</span><span class="p">)</span> <span class="p">{</span>
             <span class="nx">steps</span> <span class="p">{</span>
                <span class="nf">withCredentials</span><span class="p">([</span><span class="nf">usernamePassword</span><span class="p">(</span><span class="nx">credentialsId</span><span class="p">:</span> <span class="s">&#34;${docker_registry_auth}&#34;</span><span class="p">,</span> <span class="nx">passwordVariable</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">password</span><span class="err">&#39;</span><span class="p">,</span> <span class="nx">usernameVariable</span><span class="p">:</span> <span class="err">&#39;</span><span class="nx">username</span><span class="err">&#39;</span><span class="p">)])</span> <span class="p">{</span>
                <span class="nx">sh</span> <span class="s">&#34;&#34;&#34;
</span><span class="s">                docker build -t ${image_name} .
</span><span class="s">                docker login -u ${username} -p &#39;${password}&#39; ${registry}
</span><span class="s">                docker push ${image_name}
</span><span class="s">                &#34;&#34;&#34;</span>
                <span class="p">}</span>
           <span class="p">}</span> 
			
        <span class="p">}</span>
        <span class="nf">stage</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">部署到K8S平台</span><span class="err">&#39;</span><span class="p">){</span>
             <span class="nx">steps</span> <span class="p">{</span>
              <span class="nf">configFileProvider</span><span class="p">([</span><span class="nf">configFile</span><span class="p">(</span><span class="nx">fileId</span><span class="p">:</span> <span class="s">&#34;${k8s_auth}&#34;</span><span class="p">,</span> <span class="nx">targetLocation</span><span class="p">:</span> <span class="s">&#34;admin.kubeconfig&#34;</span><span class="p">)]){</span>
                <span class="nx">sh</span> <span class="s">&#34;&#34;&#34;
</span><span class="s">                  sed -i &#39;s#IMAGE_NAME#${image_name}#&#39; deploy.yaml
</span><span class="s">                  sed -i &#39;s#SECRET_NAME#${secret_name}#&#39; deploy.yaml
</span><span class="s">                  sed -i &#39;s#REPLICAS#${ReplicaCount}#&#39; deploy.yaml
</span><span class="s">                  kubectl apply -f deploy.yaml -n ${Namespace} --kubeconfig=admin.kubeconfig
</span><span class="s">                  sleep 120
</span><span class="s">                  kubectl get pods,svc -n ${Namespace} --kubeconfig=admin.kubeconfig
</span><span class="s">                &#34;&#34;&#34;</span>
              <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">[root@node01 docker-inbound-agent]# kubectl get pod,svc -n prod
NAME                                    READY   STATUS    RESTARTS   AGE
pod/tomcat-java-demo-5dfd566b49-cbdlm   1/1     Running   0          4m35s

NAME                       TYPE       CLUSTER-IP   EXTERNAL-IP   PORT(S)        AGE
service/tomcat-java-demo   NodePort   10.0.0.222   &lt;none&gt;        80:32088/TCP   21h
</code></pre></td></tr></table>
</div>
</div><p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202537.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202537.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202537.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202537.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202537.png"
        title="image-20210416202537732" /></p>
<p>部署成功，查看 tomcat 应用</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202515.png"
        data-srcset="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202515.png, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202515.png 1.5x, https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202515.png 2x"
        data-sizes="auto"
        alt="https://cdn.jsdelivr.net/gh/ZhaoUncle/image@main/blog/20210416202515.png"
        title="image-20210416202515414" /></p>
<h1 id="参考">参考</h1>
<ul>
<li>
<p>摘抄至，略有删改。https://github.com/fxkjnj/kubernetes/tree/main/jenkins-for_kubernetes/jenkins_deploy_kubernetes</p>
</li>
<li>
<p><a href="https://blog.51cto.com/u_14143894/2437186">https://blog.51cto.com/u_14143894/2437186</a></p>
</li>
</ul></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2021-04-12</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/k8s%E7%8E%AF%E5%A2%83-jenkins%E9%83%A8%E7%BD%B2/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/k8s/">k8s</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/%E4%BA%91cdn%E6%B1%87%E6%80%BB%E4%BB%8B%E7%BB%8D/" class="prev" rel="prev" title="云 cdn 汇总介绍"><i class="fas fa-angle-left fa-fw"></i>云 cdn 汇总介绍</a>
            <a href="/dns%E5%88%B7%E6%96%B0%E5%8A%9E%E6%B3%95/" class="next" rel="next" title="DNS刷新办法">DNS刷新办法<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="valine" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://valine.js.org/">Valine</a>.
            </noscript></div></article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.67.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020 - 2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="http://zhaouncle.github.io" target="_blank">赵叔</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>

            <div class="footer-line"><script type="text/javascript">document.write(unescape("%3Cspan id='cnzz_stat_icon_1279796942'%3E%3C/span%3E%3Cscript src='https://s4.cnzz.com/z_stat.php%3Fid%3D1279796942%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script></div>   

            <div class="footer-line"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                    <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>
                    <span id="busuanzi_container_site_uv">本文总阅读量<span id="busuanzi_value_site_uv"></span>人次</span></div>         
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/valine/valine.min.css"><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/autocomplete.js@0.37.1/dist/autocomplete.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/algoliasearch@4.2.0/dist/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"valine":{"appId":"qC7mcE4DIvgzHTOc5YaLNdUp-MdYXbMMI","appKey":"aBX50Ypl9zqu3sGf0PNLlPaW","avatar":"robohash","el":"#valine","emojiCDN":"https://cdn.jsdelivr.net/npm/emoji-datasource-google@5.0.1/img/google/64/","emojiMaps":{"100":"1f4af.png","alien":"1f47d.png","anger":"1f4a2.png","angry":"1f620.png","anguished":"1f627.png","astonished":"1f632.png","black_heart":"1f5a4.png","blue_heart":"1f499.png","blush":"1f60a.png","bomb":"1f4a3.png","boom":"1f4a5.png","broken_heart":"1f494.png","brown_heart":"1f90e.png","clown_face":"1f921.png","cold_face":"1f976.png","cold_sweat":"1f630.png","confounded":"1f616.png","confused":"1f615.png","cry":"1f622.png","crying_cat_face":"1f63f.png","cupid":"1f498.png","dash":"1f4a8.png","disappointed":"1f61e.png","disappointed_relieved":"1f625.png","dizzy":"1f4ab.png","dizzy_face":"1f635.png","drooling_face":"1f924.png","exploding_head":"1f92f.png","expressionless":"1f611.png","face_vomiting":"1f92e.png","face_with_cowboy_hat":"1f920.png","face_with_hand_over_mouth":"1f92d.png","face_with_head_bandage":"1f915.png","face_with_monocle":"1f9d0.png","face_with_raised_eyebrow":"1f928.png","face_with_rolling_eyes":"1f644.png","face_with_symbols_on_mouth":"1f92c.png","face_with_thermometer":"1f912.png","fearful":"1f628.png","flushed":"1f633.png","frowning":"1f626.png","ghost":"1f47b.png","gift_heart":"1f49d.png","green_heart":"1f49a.png","grimacing":"1f62c.png","grin":"1f601.png","grinning":"1f600.png","hankey":"1f4a9.png","hear_no_evil":"1f649.png","heart":"2764-fe0f.png","heart_decoration":"1f49f.png","heart_eyes":"1f60d.png","heart_eyes_cat":"1f63b.png","heartbeat":"1f493.png","heartpulse":"1f497.png","heavy_heart_exclamation_mark_ornament":"2763-fe0f.png","hole":"1f573-fe0f.png","hot_face":"1f975.png","hugging_face":"1f917.png","hushed":"1f62f.png","imp":"1f47f.png","innocent":"1f607.png","japanese_goblin":"1f47a.png","japanese_ogre":"1f479.png","joy":"1f602.png","joy_cat":"1f639.png","kiss":"1f48b.png","kissing":"1f617.png","kissing_cat":"1f63d.png","kissing_closed_eyes":"1f61a.png","kissing_heart":"1f618.png","kissing_smiling_eyes":"1f619.png","laughing":"1f606.png","left_speech_bubble":"1f5e8-fe0f.png","love_letter":"1f48c.png","lying_face":"1f925.png","mask":"1f637.png","money_mouth_face":"1f911.png","nauseated_face":"1f922.png","nerd_face":"1f913.png","neutral_face":"1f610.png","no_mouth":"1f636.png","open_mouth":"1f62e.png","orange_heart":"1f9e1.png","partying_face":"1f973.png","pensive":"1f614.png","persevere":"1f623.png","pleading_face":"1f97a.png","pouting_cat":"1f63e.png","purple_heart":"1f49c.png","rage":"1f621.png","relaxed":"263a-fe0f.png","relieved":"1f60c.png","revolving_hearts":"1f49e.png","right_anger_bubble":"1f5ef-fe0f.png","robot_face":"1f916.png","rolling_on_the_floor_laughing":"1f923.png","scream":"1f631.png","scream_cat":"1f640.png","see_no_evil":"1f648.png","shushing_face":"1f92b.png","skull":"1f480.png","skull_and_crossbones":"2620-fe0f.png","sleeping":"1f634.png","sleepy":"1f62a.png","slightly_frowning_face":"1f641.png","slightly_smiling_face":"1f642.png","smile":"1f604.png","smile_cat":"1f638.png","smiley":"1f603.png","smiley_cat":"1f63a.png","smiling_face_with_3_hearts":"1f970.png","smiling_imp":"1f608.png","smirk":"1f60f.png","smirk_cat":"1f63c.png","sneezing_face":"1f927.png","sob":"1f62d.png","space_invader":"1f47e.png","sparkling_heart":"1f496.png","speak_no_evil":"1f64a.png","speech_balloon":"1f4ac.png","star-struck":"1f929.png","stuck_out_tongue":"1f61b.png","stuck_out_tongue_closed_eyes":"1f61d.png","stuck_out_tongue_winking_eye":"1f61c.png","sunglasses":"1f60e.png","sweat":"1f613.png","sweat_drops":"1f4a6.png","sweat_smile":"1f605.png","thinking_face":"1f914.png","thought_balloon":"1f4ad.png","tired_face":"1f62b.png","triumph":"1f624.png","two_hearts":"1f495.png","unamused":"1f612.png","upside_down_face":"1f643.png","weary":"1f629.png","white_frowning_face":"2639-fe0f.png","white_heart":"1f90d.png","wink":"1f609.png","woozy_face":"1f974.png","worried":"1f61f.png","yawning_face":"1f971.png","yellow_heart":"1f49b.png","yum":"1f60b.png","zany_face":"1f92a.png","zipper_mouth_face":"1f910.png","zzz":"1f4a4.png"},"enableQQ":false,"highlight":true,"lang":"zh-cn","pageSize":10,"placeholder":"博主很懒，什么都没有留下！","recordIP":true,"visitor":true}},"search":{"algoliaAppID":"8GC6CRN3M8","algoliaIndex":"index.zh-cn","algoliaSearchKey":"d4467e8c57c2b12f53da9c8ec1c629be","highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"algolia"}};</script><script type="text/javascript" src="/js/theme.min.js"></script><script type="text/javascript">
            window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());
            gtag('config', 'UA-168242983-1');
        </script><script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-168242983-1" async></script></body>
</html>
